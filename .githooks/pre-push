#!/bin/sh
# Pre-push hook for GreenLedger UI
# Runs tests and build checks before pushing

echo "🚀 Running pre-push checks..."

# Check if we're pushing to main/master
protected_branch='main'
current_branch=$(git symbolic-ref HEAD | sed -e 's,.*/\(.*\),\1,')

if [ "$current_branch" = "$protected_branch" ]; then
    echo "🔒 Pushing to protected branch: $protected_branch"
    echo "🧪 Running comprehensive checks..."
    
    # Run tests if available
    if npm run test 2>/dev/null; then
        echo "✅ Tests passed!"
    else
        echo "⚠️  Tests not configured or failed"
    fi
    
    # Run build check
    echo "🏗️  Checking build..."
    if npm run build 2>/dev/null; then
        echo "✅ Build successful!"
    else
        echo "❌ Build failed!"
        exit 1
    fi
else
    echo "📝 Pushing to feature branch: $current_branch"
    echo "🔍 Running basic checks..."
fi

# Check for merge conflicts
if git diff --check; then
    echo "✅ No merge conflict markers found"
else
    echo "❌ Merge conflict markers detected!"
    exit 1
fi

echo "✅ Pre-push checks completed!"
exit 0